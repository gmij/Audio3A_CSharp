# GitHub Copilot 自定义指令

## 语言要求

**重要：所有对话必须使用中文进行交流。**

## 项目概述

这是一个基于 .NET 8 的原生音频 3A (AEC, AGC, ANS) SDK 项目。

### 技术栈
- .NET 8
- Microsoft.Extensions.DependencyInjection (依赖注入)
- Microsoft.Extensions.Logging (日志记录)
- xUnit (单元测试)

### 项目结构
- `src/Audio3A.Core/` - 核心库，包含 3A 算法实现
- `samples/Audio3A.Demo/` - 示例应用程序
- `tests/Audio3A.Tests/` - 单元测试
- `.github/workflows/` - CI/CD 自动化管道

## 核心设计原则

### KISS！SOLID！DRY！

代码实现过程中，**必须严格遵循**以下三大原则：

#### 1. KISS（Keep It Simple, Stupid - 保持简单直白）

**核心思想**：尽量使用简单的解决方案，避免过度复杂化。

**实践要求**：
- 优先选择简单的实现方式
- 避免不必要的抽象或设计模式
- 复杂的代码难以理解、测试和维护
- 简单的设计通常更可靠、更易维护
- 当问题变得复杂时再逐步优化，而非一开始就过度设计

#### 2. SOLID（面向对象设计五大原则）

**S - Single Responsibility Principle（单一职责原则）**
- 一个类应该只有一个引起它变化的原因
- 每个类只负责一项功能
- 避免"上帝类"，保持类的职责单一明确

**O - Open/Closed Principle（开放/封闭原则）**
- 软件实体应该对扩展开放，对修改封闭
- 通过扩展而非修改现有代码来实现新功能
- 使用接口和抽象类实现扩展点

**L - Liskov Substitution Principle（里氏替换原则）**
- 子类应该能替换其父类并保持原有功能的正确性
- 使用父类的地方，替换为子类后不应产生异常
- 确保继承关系的正确性

**I - Interface Segregation Principle（接口隔离原则）**
- 不应强迫客户端依赖它不需要的接口
- 将大接口拆分为多个小接口
- 避免客户端实现不必要的方法

**D - Dependency Inversion Principle（依赖反转原则）**
- 高层模块不应依赖低层模块，两者都应依赖抽象
- 抽象不应依赖细节，细节应依赖抽象
- 通过依赖注入（DI）实现解耦

#### 3. DRY（Don't Repeat Yourself - 不要重复自己）

**核心思想**：避免代码中出现重复的逻辑或数据。

**实践要求**：
- 通过抽象（如函数、类、模块）将重复逻辑封装起来
- 避免复制粘贴代码
- 重复的代码会导致修改时需要同步更新多个地方，增加出错风险
- 需要时直接调用封装好的逻辑，而非重复编写

## 代码风格和约定

### 依赖注入
- 所有服务必须通过构造函数注入
- 使用 `IServiceProvider` 解析可选依赖
- 在 `ServiceCollectionExtensions` 中注册服务
- 只注册配置启用的处理器，避免浪费资源

### 日志记录
- 使用 `ILogger<T>` 进行日志记录
- 使用结构化日志记录，包含上下文信息
- 日志级别：Debug（调试信息）、Information（重要信息）、Warning（警告）、Error（错误）

### 测试
- 所有新功能必须包含单元测试
- 测试覆盖率要求保持或提高
- 使用 `NullLogger` 在测试中禁用日志输出
- 测试命名清晰，描述测试场景

### 性能考虑
- 避免不必要的对象分配
- 使用 `Span<T>` 和 `Memory<T>` 处理大数据
- 考虑算法复杂度
- 使用静态字段减少重复初始化

## 算法实现指南

### WebRTC 参考实现
本项目的 3A 算法参考了 WebRTC 的实现思路，但针对 C# 进行了调整。

### AEC (回声消除)
- 使用 NLMS (Normalized Least Mean Squares) 自适应滤波器
- 实现双讲检测 (Double-talk Detection)
- 回声返回损耗 (ERL) 估计
- 非线性残余回声抑制

### AGC (自动增益控制)
- 实现语音活动检测 (VAD)
- 使用最小统计法进行噪声底估计
- VAD 感知的攻击/释放时间
- 软限幅器防止削波

### ANS (噪声抑制)
- 最小统计法噪声估计
- 语音概率估计
- 过减法 (Over-subtraction) 技术
- 舒适噪声注入

## Git 提交规范

### 提交消息格式
- 使用英文编写提交消息
- 格式：`<type>: <subject>`
- Type: feat (新功能), fix (修复), docs (文档), refactor (重构), test (测试), chore (杂项)

### 提交前检查
- 确保代码编译通过（0 警告）
- 确保所有单元测试通过
- 运行 CodeQL 安全扫描
- 检查代码格式

## CI/CD 流程

### GitHub Actions
- 每次提交自动触发构建和测试
- 构建必须成功，测试必须全部通过
- 失败时及时修复，不要推送失败的代码

## 代码审查要点

在审查代码时，重点关注：
1. 是否遵循 KISS、SOLID、DRY 原则
2. 是否正确使用依赖注入
3. 是否包含适当的日志记录
4. 是否有单元测试覆盖
5. 是否有性能问题
6. 是否有安全漏洞
7. 代码可读性和可维护性

## 最佳实践

### 添加新功能
1. 先编写接口定义
2. 实现核心逻辑
3. 添加依赖注入支持
4. 编写单元测试
5. 更新文档
6. 提交代码

### 修复 Bug
1. 编写能重现 Bug 的测试用例
2. 修复问题
3. 确保测试通过
4. 检查是否影响其他功能
5. 提交代码

### 重构代码
1. 确保有充分的测试覆盖
2. 小步重构，频繁提交
3. 每次重构后运行测试
4. 保持功能不变
5. 提交代码

## 注意事项

- 代码注释使用中文
- XML 文档注释使用中文
- 变量和方法命名使用英文（遵循 C# 命名约定）
- README 和文档使用中文
- 与 Copilot 的所有对话必须使用中文
