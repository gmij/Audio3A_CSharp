@page "/call/{RoomId}/{ParticipantId}"
@using Audio3A.Web.Components
@inject IApiService ApiService
@inject AudioCallService AudioService
@inject NavigationManager Navigation
@inject IMessageService Message
@implements IAsyncDisposable

<PageTitle>语音通话 - Audio3A</PageTitle>

<div class="call-container">
    @if (_room == null)
    {
        <div class="call-loading">
            <Spin Size="large" />
            <p>加载中...</p>
        </div>
    }
    else
    {
        <div class="call-header">
            <h2>@_room.Name</h2>
            <div class="call-info">
                <Badge Status="processing" Text="@($"{_callDuration:hh\\:mm\\:ss}")" />
                <span style="margin-left: 16px;">参与者: @_room.Participants.Count</span>
            </div>
        </div>

        <!-- 波形可视化区域 -->
        <div class="waveform-section">
            <div class="waveform-row">
                <WaveformVisualizer @ref="_inputWaveform" 
                                  Width="800" 
                                  Height="100" 
                                  Label="输入音频波形"
                                  Color="#1890ff"
                                  BackgroundColor="rgba(0, 0, 0, 0.3)" />
            </div>
            <div class="waveform-row">
                <WaveformVisualizer @ref="_processedWaveform" 
                                  Width="800" 
                                  Height="100" 
                                  Label="3A 处理后波形"
                                  Color="#52c41a"
                                  BackgroundColor="rgba(0, 0, 0, 0.3)" />
            </div>
        </div>

        <div class="call-main">
            <!-- 本地用户 -->
            <div class="participant-card local">
                <Avatar Size="100" Style="@GetAvatarStyle(_audioLevel)">
                    <Icon Type="user" Theme="outline" />
                </Avatar>
                <div class="participant-name">@_participantName (您)</div>
                <div class="audio-indicator">
                    <Progress Percent="@((int)(_audioLevel * 100))" ShowInfo="false" />
                </div>
            </div>

            <!-- 其他参与者 -->
            @foreach (var p in _room.Participants.Where(p => p.Id != ParticipantId))
            {
                <div class="participant-card">
                    <Avatar Size="100">
                        <Icon Type="user" Theme="outline" />
                    </Avatar>
                    <div class="participant-name">@p.Name</div>
                    <div class="audio-indicator">
                        <Progress Percent="0" ShowInfo="false" />
                    </div>
                </div>
            }
        </div>

        <div class="call-controls">
            <Button Type="@ButtonType.Default" 
                    Shape="circle" 
                    Size="large"
                    OnClick="ToggleMute"
                    Style="@GetMuteButtonStyle()">
                <Icon Type="@(AudioService.IsMuted ? "audio-muted" : "audio")" Theme="outline" />
            </Button>

            <Button Type="@ButtonType.Default" 
                    Shape="circle" 
                    Size="large"
                    OnClick="ToggleRecording"
                    Style="@GetRecordButtonStyle()">
                <Icon Type="@(AudioService.IsRecording ? "pause-circle" : "video-camera")" Theme="outline" />
            </Button>

            <Button Type="@ButtonType.Primary" 
                    Danger
                    Shape="circle" 
                    Size="large"
                    OnClick="EndCall"
                    Style="width: 80px; height: 80px; font-size: 32px;">
                <Icon Type="phone" Theme="outline" Rotate="135" />
            </Button>

            <Dropdown Trigger="@(new Trigger[] { Trigger.Click })" Disabled="@(!_hasRecordedAudio)">
                <Overlay>
                    <Menu>
                        <MenuItem OnClick="DownloadInputAudio">
                            <Icon Type="download" Theme="outline" />
                            下载原声音频
                        </MenuItem>
                        <MenuItem OnClick="DownloadProcessedAudio">
                            <Icon Type="download" Theme="outline" />
                            下载净化后音频
                        </MenuItem>
                    </Menu>
                </Overlay>
                <ChildContent>
                    <Button Type="@ButtonType.Default" 
                            Shape="circle" 
                            Size="large"
                            Disabled="@(!_hasRecordedAudio)">
                        <Icon Type="download" Theme="outline" />
                    </Button>
                </ChildContent>
            </Dropdown>

            <Button Type="@ButtonType.Default" 
                    Shape="circle" 
                    Size="large"
                    Disabled>
                <Icon Type="setting" Theme="outline" />
            </Button>
        </div>
    }
</div>

<style>
    .call-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .call-header {
        padding: 24px;
        text-align: center;
    }

    .call-header h2 {
        color: white;
        margin-bottom: 8px;
    }

    .call-info {
        color: rgba(255, 255, 255, 0.9);
    }

    .waveform-section {
        padding: 16px 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .waveform-row {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    .call-main {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 32px;
        flex-wrap: wrap;
        padding: 32px;
    }

    .participant-card {
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 24px;
        border-radius: 16px;
        backdrop-filter: blur(10px);
    }

    .participant-card.local {
        border: 2px solid #52c41a;
    }

    .participant-name {
        margin-top: 16px;
        font-size: 16px;
        font-weight: 500;
    }

    .audio-indicator {
        margin-top: 12px;
        width: 120px;
    }

    .call-controls {
        padding: 32px;
        display: flex;
        justify-content: center;
        gap: 24px;
    }

    .call-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
    }

    .call-loading p {
        margin-top: 16px;
        font-size: 16px;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }
</style>

@code {
    [Parameter]
    public string? RoomId { get; set; }

    [Parameter]
    public string? ParticipantId { get; set; }

    private RoomDetailInfo? _room;
    private string _participantName = "";
    private float _audioLevel = 0;
    private TimeSpan _callDuration = TimeSpan.Zero;
    private System.Timers.Timer? _timer;
    private bool _hasRecordedAudio = false;
    
    // 波形可视化组件引用
    private WaveformVisualizer? _inputWaveform;
    private WaveformVisualizer? _processedWaveform;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"Call.razor: OnInitializedAsync - RoomId={RoomId}, ParticipantId={ParticipantId}");
        
        // 加载房间信息
        if (!string.IsNullOrEmpty(RoomId))
        {
            _room = await ApiService.GetRoom(RoomId);
            Console.WriteLine($"Call.razor: Room loaded - {_room?.Name}, Participants={_room?.Participants.Count}");
            
            if (_room != null)
            {
                var participant = _room.Participants.FirstOrDefault(p => p.Id == ParticipantId);
                if (participant != null)
                {
                    _participantName = participant.Name;
                    Console.WriteLine($"Call.razor: Participant name={_participantName}");
                }

                // 启动音频通话
                bool enable3A = _room.EnableAec || _room.EnableAgc || _room.EnableAns;
                Console.WriteLine($"Call.razor: Starting audio call with 3A={enable3A}");
                
                await AudioService.InitializeAsync();
                Console.WriteLine("Call.razor: AudioService initialized");
                
                await AudioService.StartCallAsync(RoomId, enable3A);
                Console.WriteLine("Call.razor: AudioService started");

                // 注册事件
                AudioService.OnAudioLevel += OnAudioLevel;
                AudioService.OnInputWaveform += OnInputWaveform;
                AudioService.OnProcessedWaveform += OnProcessedWaveform;
                AudioService.OnError += OnError;
                Console.WriteLine("Call.razor: Event handlers registered");

                // 启动计时器
                _timer = new System.Timers.Timer(1000);
                _timer.Elapsed += (s, e) =>
                {
                    _callDuration = _callDuration.Add(TimeSpan.FromSeconds(1));
                    InvokeAsync(StateHasChanged);
                };
                _timer.Start();
                Console.WriteLine("Call.razor: Timer started");
            }
        }
    }

    private void OnAudioLevel(string participantId, float level)
    {
        Console.WriteLine($"Call.razor: OnAudioLevel called - participantId={participantId}, level={level:F3}");
        if (participantId == "local")
        {
            _audioLevel = level;
            Console.WriteLine($"Call.razor: Updated _audioLevel to {_audioLevel:F3}");
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnError(string message)
    {
        InvokeAsync(async () =>
        {
            await Message.Error($"通话错误: {message}");
        });
    }

    private void OnInputWaveform(byte[] waveformData)
    {
        InvokeAsync(async () =>
        {
            if (_inputWaveform != null)
            {
                await _inputWaveform.UpdateWaveformAsync(waveformData);
            }
        });
    }

    private void OnProcessedWaveform(byte[] waveformData)
    {
        InvokeAsync(async () =>
        {
            if (_processedWaveform != null)
            {
                await _processedWaveform.UpdateWaveformAsync(waveformData);
            }
        });
    }

    private async Task ToggleMute()
    {
        await AudioService.ToggleMuteAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleRecording()
    {
        if (AudioService.IsRecording)
        {
            var stopped = await AudioService.StopRecordingAsync();
            if (stopped)
            {
                _hasRecordedAudio = true;
                await Message.Success("录制已停止");
            }
        }
        else
        {
            var started = await AudioService.StartRecordingAsync();
            if (started)
            {
                await Message.Info("开始录制音频...");
            }
            else
            {
                await Message.Error("无法开始录制");
            }
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task DownloadInputAudio()
    {
        var success = await AudioService.DownloadInputAudioAsync();
        if (success)
        {
            await Message.Success("原声音频下载成功");
        }
        else
        {
            await Message.Error("下载失败，请先录制音频");
        }
    }

    private async Task DownloadProcessedAudio()
    {
        var success = await AudioService.DownloadProcessedAudioAsync();
        if (success)
        {
            await Message.Success("净化后音频下载成功");
        }
        else
        {
            await Message.Error("下载失败，请先录制音频");
        }
    }

    private async Task EndCall()
    {
        _timer?.Stop();
        await AudioService.EndCallAsync();
        
        if (!string.IsNullOrEmpty(RoomId) && !string.IsNullOrEmpty(ParticipantId))
        {
            await ApiService.LeaveRoom(RoomId, ParticipantId);
        }

        Navigation.NavigateTo(Navigation.ToAbsoluteUri("rooms").ToString(), forceLoad: false);
    }

    private string GetAvatarStyle(float level)
    {
        var scale = 1 + (level * 0.2); // 1.0 to 1.2
        var glow = (int)(level * 20); // 0 to 20
        return $"transform: scale({scale}); box-shadow: 0 0 {glow}px rgba(82, 196, 26, 0.8);";
    }

    private string GetMuteButtonStyle()
    {
        return AudioService.IsMuted ? "background-color: #ff4d4f; color: white;" : "";
    }

    private string GetRecordButtonStyle()
    {
        return AudioService.IsRecording ? "background-color: #ff4d4f; color: white; animation: pulse 1.5s infinite;" : "";
    }

    public async ValueTask DisposeAsync()
    {
        _timer?.Dispose();

        AudioService.OnAudioLevel -= OnAudioLevel;
        AudioService.OnInputWaveform -= OnInputWaveform;
        AudioService.OnProcessedWaveform -= OnProcessedWaveform;
        AudioService.OnError -= OnError;

        if (AudioService.IsConnected)
        {
            await AudioService.EndCallAsync();
        }
    }
}
