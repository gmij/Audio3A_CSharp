@page "/rooms/{RoomId}"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IMessageService Message

<PageTitle>房间详情 - Audio3A</PageTitle>

<PageHeader Title="@_room?.Name" SubTitle="@($"房间 ID: {RoomId?.Substring(0, 8)}")" OnBack="GoBack" />

@if (_loading)
{
    <div style="text-align: center; padding: 50px;">
        <Spin Size="large" />
    </div>
}
else if (_room == null)
{
    <Result Status="404" Title="房间不存在" SubTitle="该房间可能已被删除">
        <Extra>
            <Button Type="@ButtonType.Primary" OnClick="GoBack">返回列表</Button>
        </Extra>
    </Result>
}
else
{
    <Row Gutter="16">
        <AntDesign.Col Span="12">
            <Card Title="房间信息">
                <Descriptions Bordered Column="1">
                    <DescriptionsItem Title="房间名称">@_room.Name</DescriptionsItem>
                    <DescriptionsItem Title="房间 ID">@_room.Id</DescriptionsItem>
                    <DescriptionsItem Title="状态">
                        <Badge Status="@(_room.State == "Active" ? "success" : "default")" Text="@_room.State" />
                    </DescriptionsItem>
                    <DescriptionsItem Title="参与者数量">@_room.ParticipantCount / @(_room.MaxParticipants > 0 ? _room.MaxParticipants.ToString() : "∞")</DescriptionsItem>
                    <DescriptionsItem Title="创建时间">@_room.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</DescriptionsItem>
                </Descriptions>
            </Card>
        </AntDesign.Col>

        <AntDesign.Col Span="12">
            <Card Title="加入房间">
                <Form Model="@_joinModel" OnFinish="OnJoin">
                    <FormItem Label="您的名称">
                        <Input @bind-Value="@_joinModel.Name" Placeholder="请输入您的名称" />
                    </FormItem>
                    <FormItem>
                        <Button Type="@ButtonType.Primary" HtmlType="submit" Loading="@_joining" Block>
                            <Icon Type="login" Theme="outline" />
                            加入房间
                        </Button>
                    </FormItem>
                </Form>
            </Card>
        </AntDesign.Col>
    </Row>

    <Card Title="参与者列表" Style="margin-top: 16px;">
        @if (_room.Participants.Count == 0)
        {
            <Empty>
                <DescriptionTemplate>暂无参与者</DescriptionTemplate>
            </Empty>
        }
        else
        {
            <Table TItem="ParticipantInfo" DataSource="@_room.Participants" Size="TableSize.Small">
                <Column Title="名称" @bind-Field="@context.Name" />
                <Column Title="状态" @bind-Field="@context.State">
                    <Badge Status="@(context.State == "Connected" ? "success" : "default")" Text="@context.State" />
                </Column>
                <Column Title="3A 处理" @bind-Field="@context.Enable3A">
                    @(context.Enable3A ? "✓ 已启用" : "✗ 未启用")
                </Column>
                <Column Title="加入时间" @bind-Field="@context.JoinedAt">
                    @context.JoinedAt.ToString("HH:mm:ss")
                </Column>
                <ActionColumn Title="操作">
                    <Popconfirm Title="确定要移除该参与者吗？" OnConfirm="() => RemoveParticipant(context.Id)">
                        <Button Type="@ButtonType.Link" Danger Size="small">移除</Button>
                    </Popconfirm>
                </ActionColumn>
            </Table>
        }
    </Card>
}

@code {
    [Parameter]
    public string? RoomId { get; set; }

    private class RoomInfo
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public int ParticipantCount { get; set; }
        public int MaxParticipants { get; set; }
        public DateTime CreatedAt { get; set; }
        public List<ParticipantInfo> Participants { get; set; } = new();
    }

    private class ParticipantInfo
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public DateTime JoinedAt { get; set; }
        public bool Enable3A { get; set; }
    }

    private class JoinRoomModel
    {
        public string Name { get; set; } = string.Empty;
    }

    private RoomInfo? _room;
    private JoinRoomModel _joinModel = new();
    private bool _loading = true;
    private bool _joining = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoom();
    }

    private async Task LoadRoom()
    {
        _loading = true;
        try
        {
            _room = await Http.GetFromJsonAsync<RoomInfo>($"api/rooms/{RoomId}");
        }
        catch
        {
            _room = null;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnJoin()
    {
        if (string.IsNullOrWhiteSpace(_joinModel.Name))
        {
            await Message.Error("请输入您的名称");
            return;
        }

        _joining = true;
        try
        {
            var response = await Http.PostAsJsonAsync($"api/rooms/{RoomId}/participants", _joinModel);
            if (response.IsSuccessStatusCode)
            {
                await Message.Success("成功加入房间！");
                await LoadRoom();
                _joinModel.Name = string.Empty;
            }
            else
            {
                await Message.Error("加入房间失败");
            }
        }
        catch (Exception ex)
        {
            await Message.Error($"加入失败: {ex.Message}");
        }
        finally
        {
            _joining = false;
        }
    }

    private async Task RemoveParticipant(string participantId)
    {
        try
        {
            await Http.DeleteAsync($"api/rooms/{RoomId}/participants/{participantId}");
            await Message.Success("参与者已移除");
            await LoadRoom();
        }
        catch
        {
            await Message.Error("移除失败");
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("rooms");
    }
}
